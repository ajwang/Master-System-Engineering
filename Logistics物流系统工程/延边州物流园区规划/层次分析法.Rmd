---
title: "AHP层次分析法"
author: "HarryZhu"
date: "October 11, 2014"
output: html_document
---

## 1.问题来源： 

在复杂环境下，变数相互影响，难以判断最终结果

## 2.层次分析法（AHP）的思想

* 分层次考虑复杂因素对最终结果的影响情况

最高目标决策层：A

中间规则层：B1 B2 B3

最低指标层：C1 C2 C3 

> wiki https://en.wikipedia.org/wiki/Analytic_Hierarchy_Process

## 3.开始编程

```{r,echo=TRUE}

AHP <- function(判别矩阵, 影响因素) {
  
 ## 初始化判断矩阵  
  
  rownames(判别矩阵) <- 影响因素
  
  colnames(判别矩阵) <- row.names(判别矩阵)
  
  n = nrow(判别矩阵)
  
  同阶随机一致性指标RI <- c(0, 0, 0.58, 0.9, 1.12, 1.24, 1.32, 1.41, 1.45, 1.49, 1.52, 1.54, 1.56, 1.58, 1.59)
  
  ## 计算最大特征值  
  分母 <- matrix(rep(apply(判别矩阵, 2, sum), 3), 3, 3, byrow = TRUE)
  
  归一化矩阵 <- 判别矩阵/分母
  
  特征向量 <- apply(归一化矩阵, 1, mean)
  
  最终判别矩阵<- cbind(判别矩阵,特征向量)
  
  AW <- (判别矩阵 %*% 特征向量)

  最大特征值 <- sum((AW/(特征向量 * n)))
  
  ## 层次单排序的一致性检验
  
  一致性检验CI = (最大特征值 - n)/(n - 1)

  随机一致性指标CR = 一致性检验CI/同阶随机一致性指标RI[n]
  
  if (随机一致性指标CR >= 0.1) {
    print("指标CR>=0.1,请修改判断矩阵,判断矩阵的主观偏好性过强")
  }
  
  ## 输出结果
  
cat("特征向量=",特征向量,"最大特征值λmax=", 最大特征值, "一致性检验CI=", 一致性检验CI, "随机一致性指标CR", 
      随机一致性指标CR, "同阶随机一致性指标RI=", 同阶随机一致性指标RI[n])

   最终判别矩阵
}
```

## 4.仿真过程

```{r}
##初始设置

面积 <- matrix(c(1, 3, 4, (1/3), 1, 3, (1/4), (1/3), 1), 3, 3, byrow = TRUE)

交通 <- matrix(c(1, 6, 8, (1/6), 1, 3, (1/8), (1/3), 1), 3, 3, byrow = TRUE)

价格 <- matrix(c(1, (1/2), 4, (2/1), 1, 3, (1/4), (1/3), 1), 3, 3, byrow = TRUE)

房子 <- c("哥德堡", "卫星广场", "红旗街")

购房 <- matrix(c(1, (1/2), 4, (2/1), 1, 3, (1/4), (1/3), 1), 3, 3, byrow = TRUE)

购房准则<- c("面积", "交通", "价格")
```

* 计算结果

```{r,echo=FALSE}
##计算

面积判断<-AHP(面积,房子)

交通判断<-AHP(交通,房子)

价格判断<-AHP(价格,房子)

购房判断 <-AHP(购房,购房准则)

决策矩阵<-rbind(购房判断[,4],cbind(面积判断[,4],交通判断[,4],价格判断[,4]))

rownames(决策矩阵)<-c("房子",房子)
房子得分 <-apply(决策矩阵,1,sum)
```

* 利用igraph包，将图论可视化

```{r}
library(igraph)
cell<-c(1,2,1,3,1,4,2,5,2,6,2,7,3,8,3,9,3,10,4,11,4,12,4,13)
label<-c("Housing","Gedebao","SatellitePlaza","RedFlagStreet","Space","Transportation","Price","Space","Transportation","Price","Space","Transportation","Price")
t = graph(cell)
plot(t)
```

* 层次分析法示意图

```{r}
E(t)$label<-  data.frame(as.character(购房判断[,4]),as.character(面积判断[,4]),as.character(交通判断[,4]),as.character(价格判断[,4]))
V(t)[degree(t)>=2]$color <-"yellow"
plot(t,vertex.size=30,vertex.label= label)
```

* 最终决策

```{r,echo=FALSE}
最终决策<-cbind(决策矩阵,房子得分)
选择<-which(max(最终决策[2:4,4])==最终决策[2:4,4],arr.ind = TRUE)
最终决策
cat("建议：最好选购",row.names(最终决策)[选择+1] ,"的房子")
```
## 特征向量= 0.608 0.2721 0.1199 最大特征值λmax= 3.074 一致性检验CI= 0.03707 随机一致性指标CR 0.06391 同阶随机一致性指标RI= 0.58
## 特征向量= 0.753 0.1718 0.07519 最大特征值λmax= 3.075 一致性检验CI= 0.03745 随机一致性指标CR 0.06456 同阶随机一致性指标RI= 0.58
## 特征向量= 0.3601 0.5119 0.1279 最大特征值λmax= 3.109 一致性检验CI= 0.05433 随机一致性指标CR 0.09367 同阶随机一致性指标RI= 0.58
## 特征向量= 0.3601 0.5119 0.1279 最大特征值λmax= 3.109 一致性检验CI= 0.05433 随机一致性指标CR 0.09367 同阶随机一致性指标RI= 0.58
##            面积    交通   价格 房子得分
## 房子     0.3601 0.51195 0.1279   1.0000
## 哥德堡   0.6080 0.75301 0.3601   1.7211
## 卫星广场 0.2721 0.17180 0.5119   0.9558
## 红旗街   0.1199 0.07519 0.1279   0.3230
## 建议：最好选购 哥德堡 的房子


